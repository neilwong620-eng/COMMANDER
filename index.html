<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commander | å¯¦æˆ°æŒ‡æ®ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-blue: #2c3e50; --accent-blue: #3498db; --bg-gray: #f8f9fa; --card-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-gray); color: var(--primary-blue); margin: 0; padding: 20px; font-size: 0.85rem; }
        .wrapper { max-width: 1600px; margin: auto; }
        
        /* æ©«å‘ä¸‰æ¬„ç²¾ç¢ºå°é½Š */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: stretch; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: var(--card-shadow); border: 1px solid #eee; display: flex; flex-direction: column; }
        h2 { margin-top: 0; font-size: 1rem; border-left: 4px solid var(--accent-blue); padding-left: 10px; margin-bottom: 20px; }
        
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #e0e0e0; border-radius: 8px; margin-bottom: 12px; box-sizing: border-box; font-size: 0.95rem; }
        .total-display { background: var(--primary-blue); color: white; padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 15px; }
        .total-amount { font-size: 1.8rem; font-weight: 800; display: block; }
        
        .chart-container { height: 180px; margin-bottom: 15px; }
        .exp-list { max-height: 150px; overflow-y: auto; border-top: 1px solid #eee; padding-top: 10px; }
        .exp-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #f0f0f0; font-size: 0.85rem; }
        
        .suggestion-box { background: #f0f7ff; border-radius: 10px; padding: 15px; border: 1px dashed var(--accent-blue); font-size: 0.85rem; }
        .news-item { border-bottom: 1px solid #f0f0f0; padding: 10px 0; font-size: 0.85rem; }
        .news-item a { color: var(--accent-blue); text-decoration: none; font-weight: 600; }
        button { cursor: pointer; transition: opacity 0.2s; }
        button:hover { opacity: 0.8; }
    </style>
</head>
<body>

<div class="wrapper">
    <header style="text-align:center; margin-bottom:30px;">
        <h1 style="margin:0; font-size: 1.8rem;">COMMANDER</h1>
        <p style="opacity:0.7; margin: 5px 0;">å­¸ç”Ÿç”Ÿå­˜ â•³ å‰µæ¥­æ™ºåº« â•³ æ¨™çš„ç›£æ§</p>
    </header>

    <div class="main-grid">
        <div class="card">
            <h2>ğŸ’° å¸³æˆ¶è³‡ç”¢ (è‡ªå‹•æ‰£æ¬¾)</h2>
            <div style="display: flex; gap: 5px;">
                <input type="number" id="bank1" placeholder="éŠ€è¡Œ 01" oninput="calculateAll()">
                <input type="number" id="bank2" placeholder="éŠ€è¡Œ 02" oninput="calculateAll()">
                <input type="number" id="bank3" placeholder="éŠ€è¡Œ 03" oninput="calculateAll()">
            </div>
            <div style="display: flex; gap: 5px;">
                <input type="number" id="forex-bal" placeholder="å¤–å¹£é¤˜é¡" oninput="calculateAll()">
                <select id="currency-type" onchange="calculateAll()" style="width: 90px;">
                    <option value="EUR">EUR</option><option value="JPY">JPY</option><option value="USD">USD</option>
                </select>
            </div>

            <div class="total-display">
                <span id="total-val" class="total-amount">NT$ 0</span>
                <div id="rent-info" style="font-size: 0.75rem; opacity: 0.8; margin-top: 5px;">æˆ¿ç§Ÿ $6,500 ä½”æ·¨è³‡ç”¢ --%</div>
            </div>

            <div class="chart-container"><canvas id="allocationChart"></canvas></div>

            <h3 style="font-size:0.9rem; margin: 10px 0 8px 0;">ğŸ“ ä»Šæ—¥æ¶ˆè²»æ‰£æ¬¾</h3>
            <div style="display:flex; gap:5px;">
                <input type="text" id="exp-name" placeholder="é …ç›®" style="flex:2;">
                <input type="number" id="exp-amt" placeholder="é‡‘é¡" style="flex:1;">
                <button onclick="addExpense()" style="width:50px; height:43px; border-radius:8px; border:none; background:var(--accent-blue); color:white; font-weight:bold;">+</button>
            </div>
            <div id="exp-list" class="exp-list"></div>
        </div>

        <div class="card">
            <h2>ğŸš€ éŠ·å”®æˆ°ç•¥æ™ºåº«</h2>
            <textarea id="product-desc" rows="4" placeholder="ç”¢å“å…§å®¹ç‰©æè¿° (ä¾‹å¦‚ï¼šè‡ªè£½è²¼ç´™ 150å…ƒçµ„åˆ)" oninput="analyzeSales()"></textarea>
            <div style="display: flex; gap: 5px;">
                <input type="number" id="cost-input" placeholder="æ¡è³¼æˆæœ¬" oninput="analyzeSales()">
                <input type="number" id="target-price" placeholder="é æœŸå”®åƒ¹" oninput="analyzeSales()">
            </div>
            <div id="sales-result" class="suggestion-box" style="display:none; flex-grow: 1;"></div>
            <div style="margin-top:20px; font-size:0.85rem; color:#666; border-top: 1px solid #eee; padding-top: 15px;">
                ğŸ’¡ <b>ç”Ÿå­˜æŒ‡å—ï¼š</b><br>
                æ¯ä¸€ç­†è²¼ç´™çš„åˆ©æ½¤ï¼Œéƒ½æ˜¯åœ¨ç‚ºä½ ä¸‹ä¸€å£å‘¼å¸ï¼ˆæˆ¿ç§Ÿï¼‰çˆ­å–ç©ºé–“ã€‚
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ˆ æ¨™çš„æœå°‹èˆ‡å³æ™‚å¿«è¨Š</h2>
            <input type="text" id="stock-search" placeholder="æœå°‹ 0056, 00981, NVDA..." oninput="searchStock()">
            <div id="stock-advice" class="suggestion-box" style="display:none; margin-bottom: 15px;"></div>
            
            <div id="news-container" style="max-height: 500px; overflow-y: auto;">
                <div class="news-item">æ­£åœ¨åŒæ­¥ Yahoo è²¡ç¶“ä¸­æ–‡å¿«è¨Š...</div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentRates = { EUR: 34.5, JPY: 0.21, USD: 31.5 };
    let expenses = [];
    let myChart;

    function initChart() {
        const ctx = document.getElementById('allocationChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['æˆ¿ç§Ÿ(å›ºå®š)', 'ç©©å¥æŠ•è³‡', 'çµè²¨è³‡é‡‘', 'å‰©é¤˜ç¾é‡‘'],
                datasets: [{ data: [6500, 0, 0, 0], backgroundColor: ['#e74c3c', '#3498db', '#f1c40f', '#2ecc71'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } } } }
        });
    }

    async function fetchRates() {
        try {
            const res = await fetch('https://open.er-api.com/v6/latest/TWD');
            const data = await res.json();
            currentRates.EUR = 1/data.rates.EUR; currentRates.JPY = 1/data.rates.JPY; currentRates.USD = 1/data.rates.USD;
            calculateAll();
        } catch (e) {}
    }

    function calculateAll() {
        const b1 = parseFloat(document.getElementById('bank1').value) || 0;
        const b2 = parseFloat(document.getElementById('bank2').value) || 0;
        const b3 = parseFloat(document.getElementById('bank3').value) || 0;
        const forex = parseFloat(document.getElementById('forex-bal').value) || 0;
        const currType = document.getElementById('currency-type').value;
        
        const gross = b1 + b2 + b3 + (forex * currentRates[currType]);
        const totalExp = expenses.reduce((sum, item) => sum + item.amt, 0);
        const net = gross - totalExp;
        
        document.getElementById('total-val').innerText = 'NT$ ' + net.toLocaleString();
        const rentP = net > 0 ? ((6500 / net) * 100).toFixed(1) : 0;
        document.getElementById('rent-info').innerText = `æˆ¿ç§Ÿ $6,500 | ä½”æ·¨è³‡ç”¢ ${rentP}%`;

        if (myChart) {
            const investable = Math.max(0, net - 6500);
            myChart.data.datasets[0].data = [6500, investable * 0.5, investable * 0.3, investable * 0.2];
            myChart.update();
        }
        localStorage.setItem('cmd_final_v1', JSON.stringify({b1, b2, b3, forex, currType, expenses}));
    }

    function addExpense() {
        const name = document.getElementById('exp-name').value;
        const amt = parseFloat(document.getElementById('exp-amt').value);
        if (name && amt) {
            expenses.unshift({name, amt, time: new Date().toLocaleTimeString()});
            document.getElementById('exp-name').value = ''; document.getElementById('exp-amt').value = '';
            renderExpenses(); calculateAll();
        }
    }

    function renderExpenses() {
        document.getElementById('exp-list').innerHTML = expenses.map((item, index) => `
            <div class="exp-item">
                <span>${item.name} <small style="color:#999">${item.time}</small></span>
                <b>$${item.amt} <span style="cursor:pointer;color:red" onclick="removeExp(${index})">Ã—</span></b>
            </div>
        `).join('');
    }

    function removeExp(i) { expenses.splice(i, 1); renderExpenses(); calculateAll(); }

    function searchStock() {
        const s = document.getElementById('stock-search').value.toUpperCase();
        const box = document.getElementById('stock-advice');
        box.style.display = s ? 'block' : 'none';
        const db = {
            '0056': '<b>0056 å…ƒå¤§é«˜è‚¡æ¯ï¼š</b>ç©©å®šé…æ¯ï¼Œå”åŠ©æ”¯ä»˜ $6,500 æˆ¿ç§Ÿæ”¯å‡ºã€‚',
            '00981': '<b>00981 å¾©è¯æ—¥æœ¬é ˜èˆªï¼š</b>2/3ä¸Šå¸‚æ¨™çš„ï¼Œè§€å¯Ÿæ—¥ä¼åŠå°é«”å‹•èƒ½ã€‚',
            '0050': '<b>0050 å…ƒå¤§å°ç£50ï¼š</b>åˆ©æ½¤é•·æœŸå­˜æ”¾çš„é¦–é¸ã€‚'
        };
        box.innerHTML = db[s] || `åˆ†æä¸­ï¼šå»ºè­°æœå°‹ 0056, 00981 æˆ– 0050ã€‚`;
    }

    function analyzeSales() {
        const desc = document.getElementById('product-desc').value;
        const cost = parseFloat(document.getElementById('cost-input').value) || 0;
        const price = parseFloat(document.getElementById('target-price').value) || 0;
        const box = document.getElementById('sales-result');
        if (!desc && !cost && !price) { box.style.display = 'none'; return; }
        box.style.display = 'block';
        let res = `<b>åˆ©æ½¤åˆ†æï¼š</b>ç²åˆ© $${price-cost} | æ¯›åˆ©ç‡ ${(((price-cost)/price)*100).toFixed(1)}%<br>`;
        if (desc.includes("è²¼ç´™") && price >= 150) res += "ğŸ’¡ <b>å»ºè­°ï¼š</b>é«˜æ¯›åˆ©ç”¢å“ã€‚æ­¤å–®åˆ©æ½¤å¯æŠµéŠ·ç´„ä¸€å¤©çš„ç”Ÿæ´»é›œæ”¯ã€‚";
        box.innerHTML = res;
    }

    async function fetchNews() {
        try {
            const res = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://tw.news.yahoo.com/rss/finance');
            const data = await res.json();
            document.getElementById('news-container').innerHTML = data.items.slice(0, 10).map(i => `<div class="news-item"><a href="${i.link}" target="_blank">${i.title}</a></div>`).join('');
        } catch (e) {}
    }

    window.onload = function() {
        initChart();
        const saved = JSON.parse(localStorage.getItem('cmd_final_v1') || '{}');
        document.getElementById('bank1').value = saved.b1 || '';
        document.getElementById('bank2').value = saved.b2 || '';
        document.getElementById('bank3').value = saved.b3 || '';
        document.getElementById('forex-bal').value = saved.forex || '';
        document.getElementById('currency-type').value = saved.currType || 'EUR';
        expenses = saved.expenses || [];
        renderExpenses(); fetchRates(); fetchNews();
    };
</script>
</body>
</html>
